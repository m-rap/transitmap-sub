<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
       #map {
        height: 600px;
        width: 100%;
        max-width: 550px;
       }
      #renderCanvas {
        //display: block;
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
        z-index: 10;
      }
      ul {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div style="position: relative;">
      <div id="map"></div>
      <canvas id="renderCanvas"></canvas>
      <script src="/js/util.js"></script>
      <script>
        var currLoc;
        var mapDiv;
        var map;
        var srw = {lat: -7.279860921538657, lng: 112.74188160896301};
        var dragging = false;
        var txtLat;
        var txtLng;
        var txtLongCoord;
        var selType;
        var directionsService;
        var berangkat =
            [{
              request: {
                origin: null, 
                destination: null,
                waypoints: [
                ],
                optimizeWaypoints: false
              },
              color: '#61bb46'
            }];
        var kembali = [{
              request: {
                origin: null, 
                destination: null,
                waypoints: [
                ],
                optimizeWaypoints: false
              },
              color: '#61bb46'
            }];
        var selected = -1;
        var canvasInitialized = false;
        var renderCanvas;
        var renderCtx = null;
        var bounds;
        var mapWidth;
        var mapHeight;
        var widthRatio;
        var heightRatio;
        var cameraSpeed = 0;
        var lastLoc;
        var radioSelected = null;
        var listBerangkatUl;
        var listKembaliUl;

        window.onload = function() {
          txtLat = document.getElementById('txtLat');
          txtLng = document.getElementById('txtLng');
          //txtLongCoord = document.getElementById('txtLongCoord');
          //selType = document.getElementById('selType');
          listBerangkatUl = document.getElementById('listBerangkat');
          listKembaliUl = document.getElementById('listKembali');
          invalidateList();
        }
        
        function drawDirections(rute, i) {
          if (i >= rute.length) {
            return;
          }

          directionsService.route(rute[i].request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              renderCtx.beginPath();
              for (j = 0; j < response.routes[0].overview_path.length; j++) {
                var latLng = response.routes[0].overview_path[j];
                var x = (latLng.lng() - bounds.getSouthWest().lng()) * widthRatio;
                var y = renderCanvas.height - ((latLng.lat() - bounds.getSouthWest().lat()) * heightRatio);
                if (j == 0) {
                  renderCtx.moveTo(x, y);
                } else {
                  renderCtx.lineTo(x, y);
                }
              }
              
              var rgb = hexToRgb(rute[i].color);
              
              renderCtx.lineWidth = 3;
              renderCtx.strokeStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + '1.0)';
              renderCtx.stroke();

              i++;
              drawDirections(rute, i);
            } else {
              console.log(i + ' ' + status + '. retrying..');
              setTimeout(function() {
                drawDirections(rute, i)
              }, 2000);
            }
          });
        }
        
        function initCanvas() {
          if (!canvasInitialized) {
            canvasInitialized = true;
            renderCanvas = document.getElementById('renderCanvas');
            renderCanvas.style.pointerEvents = 'none';
            renderCtx = renderCanvas.getContext('2d');
          }
          
          renderCanvas.width = mapDiv.clientWidth;
          renderCanvas.height = mapDiv.clientHeight;
          renderCtx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
          bounds = map.getBounds(); 
          mapWidth = bounds.getNorthEast().lng() - bounds.getSouthWest().lng();
          mapHeight = bounds.getNorthEast().lat() - bounds.getSouthWest().lat();
          widthRatio = renderCanvas.width / mapWidth;
          heightRatio = renderCanvas.height / mapHeight;
        }

        function drawAll() {
          initCanvas();
          
          for (i in berangkat)
            berangkat[i].request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
          for (i in kembali)
            kembali[i].request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
          
          var rute = new Array();
          for (i in berangkat) {
            if (berangkat[i].request.origin == null || berangkat[i].request.destination == null)
              continue;
            rute.push(berangkat[i]);
          }
          for (i in kembali) {
            if (kembali[i].request.origin == null || kembali[i].request.destination == null)
              continue;
            rute.push(kembali[i]);
          }
          if (rute.length > 0)
            drawDirections(rute, 0);
        }

        function initMap() {
          currLoc = srw;
          mapDiv = document.getElementById('map');
          map = new google.maps.Map(mapDiv, {
            zoom: 13,
            center: currLoc,
            styles: [],
            draggableCursor: 'pointer'
          });
          
          currLoc = map.getCenter();
          lastLoc = currLoc;
          
          map.addListener('click', function(e) {
            var latLng = e.latLng;
            txtLat.value = latLng.lat();
            txtLng.value = latLng.lng();
            //txtLongCoord.value = '{lat: ' + latLng.lat() + ', lng: ' + latLng.lng() + '} // ';
          });

          directionsService = new google.maps.DirectionsService();
          
          map.addListener('dragstart', function() {
            dragging = true;
            if (renderCtx != null)
              renderCtx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
          });
          
          map.addListener('dragend', function() {
            dragging = false;
          });
          
          setInterval(function() {
            var center = map.getCenter();
            cameraSpeed = Math.sqrt(Math.pow(center.lat() - currLoc.lat(), 2) + Math.pow(center.lng() - currLoc.lng(), 2));
            currLoc = center;
            if (cameraSpeed === 0.0) {
              if (currLoc.lat() != lastLoc.lat() || currLoc.lng() != lastLoc.lng()) {
                drawAll();
                lastLoc = currLoc;
              }
            } else {
              if (renderCtx != null)
                renderCtx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
            }
          }, 100);
        }
        
        function addPoint() {
          if (radioSelected == null)
            return;
          
          if (isNaN(txtLat.value) || isNaN(txtLng.value))
            return;
          var location = {lat: Number(txtLat.value), lng: Number(txtLng.value)};
          
          var request;
          if (radioSelected.type == 0) {
            request = berangkat[radioSelected.idx].request;
          } else {
            request = kembali[radioSelected.idx].request;
          }
          //if (selType.options[selType.selectedIndex].value == 'berangkat') {
          //  request = berangkat[0].request;
          //} else {
          //  request = kembali[0].request;
          //}
          
          if (request.destination != null) {
            request.waypoints.push({location: request.destination, stopover: false});
            request.destination = null;
          }
          if (request.origin == null) {
            request.origin = location;
          } else {
            request.destination = location;
          }
          
          if (radioSelected.type == 0) {
            berangkat[radioSelected.idx].request = request;
          } else {
            kembali[radioSelected.idx].request = request;
          }
          
          //if (selType.options[selType.selectedIndex].value == 'berangkat') {
          //  berangkat[0].request = request;
          //} else {
          //  kembali[0].request = request;
          //}
          
          invalidateList();
          if (request.origin != null && request.destination != null)
            drawAll();
        }
        
        function addList(type) {
          var temp;
          if (type == 0) {
            temp = berangkat;
          } else {
            temp = kembali;
          }
          temp.push({
              request: {
                origin: null, 
                destination: null,
                waypoints: [
                ],
                optimizeWaypoints: false
              },
              color: '#61bb46'
            });
          if (type == 0) {
            berangkat = temp;
          } else {
            kembali = temp;
          }
          invalidateList();
        }
        
        function invalidateList() {
          var ul;
          var temp = [listBerangkatUl, listKembaliUl];
          var temp1 = [berangkat, kembali];
          var temp2 = ['berangkat', 'kembali'];
          for (a in temp) {
            ul = temp[a];
            var htmlStr = "";
            for (i in temp1[a]) {
              var checked = ((radioSelected != null) ? (radioSelected.type == a && radioSelected.idx == i) ? "checked" : "" : "");
              htmlStr += "\n\
          <li><input name=\"radLoc\" type=\"radio\" onchange=\"radLocOnChange(" + a + ", " + i + ")\" " + checked + "/> " + temp2[a] + " " + (Number(i)+1) +" <input type=\"button\" value=\"Remove\" />\n\
            <ul id=\"" + temp2[a] + (i) + "\">\n";
              var waypoints = temp1[a][i].request.waypoints.slice();
              if (temp1[a][i].request.origin != null) {
                waypoints.splice(0, 0, {location: temp1[a][i].request.origin, stopover: false});
              }
              if (temp1[a][i].request.destination != null) {
                waypoints.push({location: temp1[a][i].request.destination, stopover: false});
              }
              for (j in waypoints) {
                htmlStr += "\
              <li>lat: " + waypoints[j].location.lat + ", lng: " + waypoints[j].location.lng + "  <input type=\"button\" value=\"Remove\" /></li>";
              }
              htmlStr += "\
            </ul>\n\
          </li>";
            }
            ul.innerHTML = htmlStr;
          }
        }
        
        function radLocOnChange(type, idx) {
          radioSelected = {type: type, idx: idx};
        }
      </script>
      <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAppL0GXx5hISM9TBQExY60E_Bbamejdg&callback=initMap">
      </script>
      <input type="text" id="txtLat" />
      <input type="text" id="txtLng" />
      <!--<input type="text" id="txtLongCoord" />-->
      <!--<select id="selType">
        <option value="berangkat">Berangkat</option>
        <option value="kembali">Kembali</option>
      </select>-->
      <input type="button" id="btnAdd" value="Add" onclick="addPoint()" />
      <div>
        List berangkat: <input type="button" value="Add" onclick="addList(0)" />
        <ul id="listBerangkat">
        </ul>
      </div>
      <div>
        List kembali: <input type="button" value="Add" onclick="addList(1)" />
        <ul id="listKembali">
        </ul>
      </div>
    </div>
  </body>
</html>