<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      body, html {
        height: 100%;
      }
      #map {
        height: 800px;
        width: 100%;
      }
      #renderCanvas {
        position: absolute;
        z-index: 10;
      }
      #fullTest {
        position: absolute;
        top: 0;
        bottom: 0;
      }
      ul {
        margin: 0;
      }
      code {
        display: block;
      }
    </style>
  </head>
  <body>
    <div style="position: relative; height: 100%;">
      <!--<div id="fullTest"></div>-->
      <canvas id="renderCanvas"></canvas>
      <div id="map"></div>
      <script src="/js/util.js"></script>
      <script>
        var fullTest;
        var currLoc;
        var mapDiv = null;
        var map;
        var srw = {lat: -7.279860921538657, lng: 112.74188160896301};
        var dragging = false;
        var txtLat;
        var txtLng;
        var txtLongCoord;
        var txtName;
        var selType;
        var directionsService;
        var berangkat =
            [{
              request: {
                origin: null, 
                destination: null,
                waypoints: [
                ],
                optimizeWaypoints: false
              },
              color: '#61bb46'
            }];
        var kembali = [{
              request: {
                origin: null, 
                destination: null,
                waypoints: [
                ],
                optimizeWaypoints: false
              },
              color: '#61bb46'
            }];
        var selected = -1;
        var renderCanvas;
        var renderCtx = null;
        var bounds;
        var mapWidth;
        var mapHeight;
        var widthRatio;
        var heightRatio;
        var cameraSpeed = 0;
        var lastLoc;
        var radioSelected = null;
        var listBerangkatUl;
        var listKembaliUl;
        var jscode;
        var retrying = false;
        var statusSpan;

        window.onload = function() {
          //fullTest = document.getElementById('fullTest');
          renderCanvas = document.getElementById('renderCanvas');
          renderCanvas.style.pointerEvents = 'none';
          renderCtx = renderCanvas.getContext('2d');
          if (mapDiv == null)
            mapDiv = document.getElementById('map');
          //mapDiv.style.height = fullTest.clientHeight + 'px';
          txtLat = document.getElementById('txtLat');
          txtLng = document.getElementById('txtLng');
          txtLongCoord = document.getElementById('txtLongCoord');
          txtName = document.getElementById('txtName');
          listBerangkatUl = document.getElementById('listBerangkat');
          listKembaliUl = document.getElementById('listKembali');
          jscode = document.getElementById('jscode');
          statusSpan = document.getElementById('status');
          initMap();
          invalidateList();
        }
        
        function drawDirections(rute, i) {
          if (i >= rute.length) {
            statusSpan.innerHTML = "Status: Ready";
            return;
          }
          
          statusSpan.innerHTML = "Status: Requesting route " + (i + 1);

          directionsService.route(rute[i].request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              retrying = false;
              renderCtx.beginPath();
              for (j = 0; j < response.routes[0].overview_path.length; j++) {
                var latLng = response.routes[0].overview_path[j];
                var x = (latLng.lng() - bounds.getSouthWest().lng()) * widthRatio;
                var y = renderCanvas.height - ((latLng.lat() - bounds.getSouthWest().lat()) * heightRatio);
                if (j == 0) {
                  renderCtx.moveTo(x, y);
                } else {
                  renderCtx.lineTo(x, y);
                }
              }
              
              var rgb = hexToRgb(rute[i].color);
              
              renderCtx.lineWidth = 3;
              renderCtx.strokeStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + '1.0)';
              renderCtx.stroke();

              i++;
              drawDirections(rute, i);
            } else {
              statusSpan.innerHTML = "Status: " + status + " route " + (i + 1) + ". Retrying...";
              if (status == google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
                retrying = true;
                setTimeout(function() {
                  drawDirections(rute, i)
                }, 500);
              }
            }
          });
        }
        
        function initCanvas() {
          renderCanvas.width = mapDiv.clientWidth;
          renderCanvas.height = mapDiv.clientHeight;
          renderCtx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
          bounds = map.getBounds(); 
          mapWidth = bounds.getNorthEast().lng() - bounds.getSouthWest().lng();
          mapHeight = bounds.getNorthEast().lat() - bounds.getSouthWest().lat();
          widthRatio = renderCanvas.width / mapWidth;
          heightRatio = renderCanvas.height / mapHeight;
        }

        function drawAll() {
          if (retrying)
            return;
          
          initCanvas();
          
          for (i in berangkat)
            berangkat[i].request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
          for (i in kembali)
            kembali[i].request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
          
          var rute = new Array();
          for (i in berangkat) {
            if (berangkat[i].request.origin == null || berangkat[i].request.destination == null)
              continue;
            var checkbox = document.getElementById("seldraw_0_" + i);
            if (checkbox != null && !checkbox.checked)
              continue;
            rute.push(berangkat[i]);
          }
          for (i in kembali) {
            if (kembali[i].request.origin == null || kembali[i].request.destination == null)
              continue;
            var checkbox = document.getElementById("seldraw_1_" + i);
            if (checkbox != null && !checkbox.checked)
              continue;
            rute.push(kembali[i]);
          }
          if (rute.length > 0)
            drawDirections(rute, 0);
        }

        function initMap() {
          currLoc = srw;
          if (mapDiv == null)
            mapDiv = document.getElementById('map');
          map = new google.maps.Map(mapDiv, {
            zoom: 13,
            center: currLoc,
            styles: [],
            draggableCursor: 'pointer'
          });
          
          currLoc = map.getCenter();
          lastLoc = currLoc;
          
          map.addListener('click', function(e) {
            var latLng = e.latLng;
            txtLat.value = latLng.lat();
            txtLng.value = latLng.lng();
            txtLongCoord.value = '{lat: ' + latLng.lat() + ', lng: ' + latLng.lng() + '}';
          });

          directionsService = new google.maps.DirectionsService();
          
          map.addListener('dragstart', function() {
            dragging = true;
            if (renderCtx != null)
              renderCtx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
          });
          
          map.addListener('dragend', function() {
            dragging = false;
          });
          
          setInterval(function() {
            var center = map.getCenter();
            cameraSpeed = Math.sqrt(Math.pow(center.lat() - currLoc.lat(), 2) + Math.pow(center.lng() - currLoc.lng(), 2));
            currLoc = center;
            if (cameraSpeed === 0.0) {
              if (currLoc.lat() != lastLoc.lat() || currLoc.lng() != lastLoc.lng()) {
                drawAll();
                lastLoc = currLoc;
              }
            } else {
              if (renderCtx != null)
                renderCtx.clearRect(0, 0, renderCanvas.width, renderCanvas.height);
            }
          }, 100);
        }
        
        function addPoint() {
          if (radioSelected == null)
            return;
          
          if (isNaN(txtLat.value) || isNaN(txtLng.value))
            return;
          var location = {lat: Number(txtLat.value), lng: Number(txtLng.value)};
          
          var request = (radioSelected.type == 0) ?
              berangkat[radioSelected.idx].request :
              kembali[radioSelected.idx].request;
          
          if (request.destination != null) {
            request.waypoints.push({location: request.destination, stopover: false});
            request.destination = null;
          }
          if (request.origin == null) {
            request.origin = location;
          } else {
            request.destination = location;
          }
          
          invalidateList();
          if (request.origin != null && request.destination != null)
            drawAll();
        }
        
        function addList(type) {
          var temp;
          if (type == 0) {
            temp = berangkat;
          } else {
            temp = kembali;
          }
          temp.push({
              request: {
                origin: null, 
                destination: null,
                waypoints: [
                ],
                optimizeWaypoints: false
              },
              color: '#61bb46'
            });
          if (type == 0) {
            berangkat = temp;
          } else {
            kembali = temp;
          }
          invalidateList();
        }
        
        function invalidateList() {
          var ul;
          var temp = [listBerangkatUl, listKembaliUl];
          var temp1 = [berangkat, kembali];
          var temp2 = ['berangkat', 'kembali'];
          for (a in temp) {
            ul = temp[a];
            var htmlStr = "";
            for (i in temp1[a]) {
              var checked = ((radioSelected != null) ? (radioSelected.type == a && radioSelected.idx == i) ? "checked" : "" : "");
              var seldrawChecked = true;
              var checkbox = document.getElementById("seldraw_" + a + "_" + i);
              if (checkbox != null && !checkbox.checked)
                seldrawChecked = false;
              htmlStr += "\n\
          <li><input name=\"radLoc\" type=\"radio\" onchange=\"radLocOnChange(" + a + ", " + i + ")\" " + checked + "/> " + temp2[a] + " " + (Number(i)+1) +" <input type=\"button\" value=\"Remove\" onclick=\"removeRoute(" + a + ", " + i + ")\" />\n\
            <input id=\"txtColor_" + a + "_" + i + "\" type=\"text\" value=\"" + temp1[a][i].color + "\" style=\"width: 60px;\">\n\
            <input id=\"seldraw_" + a + "_" + i + "\" type=\"checkbox\" onchange=\"drawAll()\" " + ((seldrawChecked) ? "checked" : "") + "> Draw\n\
            <ul id=\"" + temp2[a] + (i) + "\">\n";
              var waypoints = temp1[a][i].request.waypoints.slice();
              if (temp1[a][i].request.origin != null) {
                waypoints.splice(0, 0, {location: temp1[a][i].request.origin, stopover: false});
              }
              if (temp1[a][i].request.destination != null) {
                waypoints.push({location: temp1[a][i].request.destination, stopover: false});
              }
              for (j in waypoints) {
                htmlStr += "\
              <li>lat: " + waypoints[j].location.lat + ", lng: " + waypoints[j].location.lng + "  <input type=\"button\" value=\"Remove\" onclick=\"removeLoc(" + a + ", " + i + ", " + j + ")\" /></li>";
              }
              htmlStr += "\
            </ul>\n\
          </li>";
            }
            ul.innerHTML = htmlStr;
          }
          generateCode();
        }
        
        function radLocOnChange(type, idx) {
          radioSelected = {type: type, idx: idx};
        }
        
        function removeRoute(type, idx) {
          if (type == 0) {
            berangkat.splice(idx, 1);
          } else {
            kembali.splice(idx, 1);
          }
          radioSelected = null;
          invalidateList();
          drawAll();
        }
        
        function removeLoc(type, idx, locIdx) {
          var request = (type == 0) ? berangkat[idx].request : kembali[idx].request;
          if (request.origin != null) {
            request.waypoints.splice(0, 0, {location: request.origin, stopover: false});
            request.origin = null;
          }
          if (request.destination != null) {
            request.waypoints.push({location: request.destination, stopover: false});
            request.destination = null;
          }
          request.waypoints.splice(locIdx, 1);
          if (request.waypoints.length > 0) {
            request.origin = request.waypoints[0].location;
            request.waypoints.splice(0, 1);
          }
          if (request.waypoints.length > 0) {
            request.destination = request.waypoints[request.waypoints.length - 1].location;
            request.waypoints.splice(request.waypoints.length - 1, 1);
          }
          invalidateList();
          drawAll();
        }
        
        function locToCode(loc) {
          if (loc == null)
            return "null";
          if (typeof loc == "string")
            return loc;
          return "{lat: " + loc.lat + ", lng: " + loc.lng + "}";
        }
        
        function waypointToCode(waypoint) {
          return "{location: " + locToCode(waypoint.location) + ", stopover: false}";
        }
        
        function routesToCode(routes) {
          var htmlStr = "";
          for (i in routes) {
            var request = routes[i].request;
            htmlStr += "{\n\
    request:\n\
    {\n\
      origin: " + locToCode(request.origin) + ",\n\
      destination: " + locToCode(request.destination) + ",\n\
      waypoints: [\n";
    for (j in request.waypoints) {
      htmlStr += "\
        " + waypointToCode(request.waypoints[j]) + ((j == request.waypoints.length - 1) ? "" : ",") + "\n";
    }
    htmlStr += "\
      ],\n\
      optimizeWaypoints: false,\n\
    },\n\
    color: \"" + routes[i].color + "\"\n\
  }" + ((i == routes.length - 1) ? "" : ", ");
          }
          return htmlStr;
        }
        
        function generateCode() {
          var htmlStr = "\
{\n\
  nama: \"" + txtName.value + "\",\n\
  berangkat: [" + routesToCode(berangkat) + "],\n\
  kembali: [" + routesToCode(kembali) + "]\n\
}";
          jscode.value = htmlStr;
        }
        
        function importCode() {
          eval("var parsed = " + jscode.value);
          berangkat = parsed.berangkat;
          kembali = parsed.kembali;
          invalidateList();
          drawAll();
        }
        
        function saveInputs() {
          var temp = [berangkat, kembali];
          for (i in temp) {
            for (j in temp[i]) {
              var txtColor = document.getElementById("txtColor_" + i + "_" + j);
              if (txtColor == null)
                continue;
              temp[i][j].color = txtColor.value;
            }
          }
          invalidateList();
        }
      </script>
      <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAppL0GXx5hISM9TBQExY60E_Bbamejdg">
      </script>
      <input type="text" id="txtLat" />
      <input type="text" id="txtLng" />
      <input type="text" id="txtLongCoord" style="width: 300px;" />
      <input type="button" id="btnAdd" value="Add" onclick="addPoint()" />
      <input type="button" value="Refresh" onclick="drawAll()" />
      <span id="status"></span><br /><br />
      <div>
        Nama: <input id="txtName" type="text" /><br />
        List berangkat: <input id="txtBerangkatColor" type="text" style="width: 60px;" value="#61bb46" /> <input type="button" value="Add" onclick="addList(0)" />
        <ul id="listBerangkat">
        </ul>
        List kembali: <input id="txtKembaliColor" type="text" style="width: 60px;" value="#61bb46" /> <input type="button" value="Add" onclick="addList(1)" />
        <ul id="listKembali">
        </ul>
        <input type="button" value="Save" onclick="saveInputs()" /><br />
      </div>
      Code:<br/>
      <textarea id="jscode" cols="160" rows="30"></textarea><br />
      <input type="button" value="Import" onclick="importCode()" />
      <br />
      <br />
    </div>
  </body>
</html>