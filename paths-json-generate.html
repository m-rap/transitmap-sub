<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
  </head>
  <body>
    <div style="position: relative;">
      <div id="status"></div>
      <div id="code"></div>
      <script src="/data/sub.js"></script>
      <script>
        var statusDiv;
        var codeDiv;
        var directionsService;
        var data = null;
        var routes = new Array();

        window.onload = function() {
          statusDiv = document.getElementById('status');
          codeDiv = document.getElementById('code');
          initData();
        }
        
        function getRoutes(rute, i) {
          if (i >= rute.length) {
            statusDiv.innerHTML = "done";
            codeDiv.innerHTML = JSON.stringify(routes);
            return;
          }
          
          statusDiv.innerHTML = "requesting " + rute[i].nama;

          directionsService.route(rute[i].request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              var path = new Array();
              for (k in response.routes) {
                for (j in response.routes[k].overview_path) {
                  path.push(response.routes[k].overview_path[j]);
                }
              }
              routes.push({nama: rute[i].nama, tipe: rute[i].tipe, color: rute[i].color, path: path});
              i++;
              getRoutes(rute, i);
            }  else {
              console.log(i + ' ' + status);
              if (status == google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
                console.log('Retrying..');
                setTimeout(function() {
                  getRoutes(rute, i)
                }, 1000);
              }
            }
            
            
          });
        }

        function initMap() {
          if (data == null) {
            setTimeout(initMap, 50);
            return;
          }

          for (a in data) {
            for (i in data[a].berangkat)
              data[a].berangkat[i].request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
            for (i in data[a].kembali)
              data[a].kembali[i].request.travelMode = google.maps.DirectionsTravelMode.DRIVING;
          }

          directionsService = new google.maps.DirectionsService();
          
          var rute = new Array();
          for (a in data) {
            for (i in data[a].berangkat) {
              data[a].berangkat[i].nama = data[a].nama;
              data[a].berangkat[i].tipe = 'berangkat';
              rute.push(data[a].berangkat[i]);
            }
            for (i in data[a].kembali) {
              data[a].kembali[i].nama = data[a].nama;
              data[a].kembali[i].tipe = 'kembali';
              rute.push(data[a].kembali[i]);
            }
          }
          getRoutes(rute, 0);
        }
      </script>
      <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAppL0GXx5hISM9TBQExY60E_Bbamejdg&callback=initMap">
      </script>
    </div>
  </body>
</html>
